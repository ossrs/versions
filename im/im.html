<!DOCTYPE html>
<html>
<head>
    <title>Transport over IM</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
</head>
<body>
<div>
    <p id="logins">
        <input id="userId" value="user0">
        <input id="password" type="password" value="">
        <button id="login">Login</button>
        <button id="logout">Logout</button>
        <button id="sha256">Sha256</button>
    </p>
    <div id="rooms">
        <p>
            <input id="roomID" value="MyMeeting">
            <button id="createRoom">Create Room</button>
            <button id="deleteRoom">Delete Room</button>
        </p>
        <p>
            <input id="roomID4Join" value="MyMeeting">
            <button id="joinRoom">Join Room</button>
            <button id="leaveRoom">Leave Room</button>
        </p>
        <p>
            <input id="ownerID" value="user1">
            <input id="roomID4Owner" value="MyMeeting">
            <button id="changeOwner">Change Owner</button>
        </p>
        <p>
            <input id="msg" value="Hello, world!">
            <input id="to" value="user1">
            <input id="group" type="checkbox"> Group
            <button id="send">Send Message</button>
        </p>
    </div>
    <pre id="outputs"></pre>
    <pre id="message"></pre>
</div>
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/lib-generate-test-usersig.min.js"></script>
<script src="js/tim-js.js"></script>
<script src="js/tim-upload-plugin.js"></script>
<script src="js/sha256.min.js"></script>
<script type="text/javascript">
    let service = 'https://api.ossrs.net/im-service/v1/'; // The service prefix.
    //let service = 'https://service-oa1p55d0-1303949587.gz.apigw.tencentcs.com/im-service/v1/';

    function output(res) {
        $('#outputs').text(JSON.stringify(res, null, '  '));
    }
    function message(res) {
        $('#message').text(JSON.stringify(res, null, '  '));
    }

    $(function () {
        $('#rooms').hide();

        $('#sha256').click(() => {
            output({plaintext: $('#password').val(), cipher: sha256($('#password').val())});
        });

        let tim = null; // TIM object.

        // 登录，向IM注册用户
        $('#login').click(async () => {
            const conf = await $.post(service + 'login?user=' + $('#userId').val() + '&password=' + sha256($('#password').val())).promise();
            console.log('server login ok', conf); output(conf);

            tim = TIM.create({SDKAppID: conf.SDKAppID});
            tim.setLogLevel(1); // 0: Normal, 1: Release, 2: Warning, 3: Error, 4: Disabled.
            tim.registerPlugin({'tim-upload-plugin': TIMUploadPlugin});
            tim.on(TIM.EVENT.SDK_READY, async (event) => {
                $('#rooms').show();
            });
            tim.on(TIM.EVENT.MESSAGE_RECEIVED, async (event) => {
                console.log('received message', event); message(event);
            });
            await tim.login({userID: conf.userID, userSig: conf.userSig});

            $('#logout').click(async () => {
                await tim.logout();
            });
        });

        // 创建房间，向IM创建群组
        $('#createRoom').click(async () => {
            let gid = $('#roomID').val();
            const res = await tim.createGroup({type: TIM.TYPES.GRP_MEETING, name: gid, groupID: gid});
            console.log('im', res); output(res);
        });

        $('#deleteRoom').click(async () => {
            const res = await tim.dismissGroup($('#roomID').val());
            console.log('im', res); output(res);
        });

        // 加入房间，在IM加入群组
        $('#joinRoom').click(async () => {
            let gid = $('#roomID4Join').val();
            const res = await tim.joinGroup({type: TIM.TYPES.GRP_MEETING, applyMessage: 'Hello', groupID: gid});
            console.log('im', res); output(res);
        });

        $('#leaveRoom').click(async () => {
            const res = await tim.quitGroup($('#roomID4Join').val());
            console.log('im', res); output(res);
        });

        // 离开房间转让权限，在IM转让群主身份
        $('#changeOwner').click(async () => {
            let ownerID = $('#ownerID').val();
            let gid = $('#roomID4Owner').val();
            const res = await tim.changeGroupOwner({groupID: gid, newOwnerID: ownerID});
            console.log('im', res); output(res);
        });

        // 发送消息给个人或群组
        $('#group').click(() => {
            $('#to').val($('#group').is(':checked')? 'MyMeeting' : 'user1');
        });
        $('#send').click(async () => {
            const res = await tim.sendMessage(tim.createTextMessage({
                to: $('#to').val(),
                conversationType: $('#group').is(':checked') ? TIM.TYPES.CONV_GROUP : TIM.TYPES.CONV_C2C,
                payload: {
                    // For text message.
                    text: $('#msg').val(),
                },
            }));
            console.log('im', res); output(res);
        });
    });
</script>
</body>
</html>