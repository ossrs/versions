<!DOCTYPE html>
<html>
<head>
    <title>Transport over IM</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
</head>
<body>
<div>
    <p id="logins">
        <input id="userId" value="user0">
        <input id="password" type="password" value="">
        <button id="login">Login</button>
        <button id="logout">Logout</button>
        <button id="sha256">Sha256</button>
    </p>
    <div id="rooms">
        <p>
            <input id="roomID" value="SrsSystemLogs">
            <select id="roomType">
                <option value="Private">Private, 好友工作群（Work）</option>
                <option value="Public">Public, 陌生人社交群（Public）</option>
                <option value="ChatRoom">ChatRoom, 临时会议群（Meeting）</option>
                <option value="AVChatRoom" selected>AVChatRoom, 直播群（AVChatRoom）</option>
            </select>
            <button id="enterRoom">Enter Room</button>
            <button id="leaveRoom">Leave Room</button>
            <button id="deleteRoom">Delete Room</button>
        </p>
        <p>
            <input id="ownerID" value="user1">
            <input id="roomID4Owner" value="SrsSystemLogs">
            <button id="changeOwner">Change Owner</button>
        </p>
        <p>
            <input id="msg" value="Hello, world!">
            <input id="to" value="user1">
            <input id="group" type="checkbox"> Group
            <input id="timestamp" type="checkbox"> Timestamp
            <button id="send">Send Message</button>
        </p>
    </div>
    <pre id="outputs"></pre>
    <pre id="message"></pre>
</div>
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/lib-generate-test-usersig.min.js"></script>
<script src="js/tim-js.js"></script>
<script src="js/tim-upload-plugin.js"></script>
<script src="js/sha256.min.js"></script>
<script type="text/javascript">
    let service = 'https://api.ossrs.net'; // The service prefix.
    //let service = 'https://service-oa1p55d0-1303949587.gz.apigw.tencentcs.com';

    let token = null; // The token to identify user, return by login.
    function wrap(r) {
        return token? (r + '&user=' + token.user + '&token=' + token.token) : r;
    }

    function output(res) {
        $('#outputs').text(JSON.stringify(res, null, '  '));
    }
    function message(res) {
        $('#message').text(JSON.stringify(res, null, '  '));
    }

    $(function () {
        $('#rooms').hide();

        $('#sha256').click(() => {
            output({plaintext: $('#password').val(), cipher: sha256($('#password').val())});
        });

        // 登录，向IM注册用户
        $('#login').click(async () => {
            const conf = await $.post(service + '/im-service/v1/login?user=' + $('#userId').val() + '&password=' + sha256($('#password').val())).promise();
            console.log('server login ok', conf); output(conf);
            token = {user: conf.userID, token: conf.token};

            const tim = TIM.create({SDKAppID: conf.SDKAppID});
            tim.setLogLevel(1); // 0: Normal, 1: Release, 2: Warning, 3: Error, 4: Disabled.
            tim.registerPlugin({'tim-upload-plugin': TIMUploadPlugin});
            tim.on(TIM.EVENT.SDK_READY, async (event) => {
                $('#rooms').show();
            });
            tim.on(TIM.EVENT.MESSAGE_RECEIVED, async (event) => {
                console.log('received message', event); message(event);
            });
            await tim.login({userID: conf.userID, userSig: conf.userSig});

            $('#logout').click(async () => {
                await tim.logout();
            });
        });

        // 进入房间，在IM加入群组，若不存在则创建群组
        $('#enterRoom').click(async () => {
            const r = wrap(service + '/im-service/v1/enter_room?id=' + $('#roomID').val() + '&type=' + $('#roomType').val());
            const res = await $.post(r).promise();
            console.log('server enter room ok', res); output(res);
        });

        $('#deleteRoom').click(async () => {
            const r = wrap(service + '/im-service/v1/delete_room?id=' + $('#roomID').val());
            const res = await $.post(r).promise();
            console.log('server delete room ok', res); output(res);
        });

        $('#leaveRoom').click(async () => {
            const r = wrap(service + '/im-service/v1/leave_room?id=' + $('#roomID').val());
            const res = await $.post(r).promise();
            console.log('server leave room ok', res); output(res);
        });

        // 离开房间转让权限，在IM转让群主身份
        $('#changeOwner').click(async () => {
            const r = wrap(service + '/im-service/v1/change_owner?id=' + $('#roomID4Owner').val() + '&to=' + $('#ownerID').val());
            const res = await $.post(r).promise();
            console.log('server leave room ok', res); output(res);
        });

        // 发送消息给个人或群组
        $('#send').click(async () => {
            const apiName = $('#group').is(':checked')? '/im-service/v1/send_group_msg' : '/im-service/v1/sendmsg';
            const msg = ($('#timestamp').is(':checked')? new Date().getTime() + ': ' : '') +$('#msg').val();
            const r = wrap(service + apiName + '?from=' + $('#userId').val() + '&to=' + $('#to').val());
            const res = await $.post(r, JSON.stringify({msg: msg})).promise();
            console.log('server sendmsg ok', res); output(res);
        });
        $('#group').click(() => {
            $('#to').val($('#group').is(':checked')? 'SrsSystemLogs' : 'user1');
        });
    });
</script>
</body>
</html>